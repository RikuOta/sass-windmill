@import './windmill-utils';
@import './windmill-lib';

// ------------------------------
// Default settings
// ------------------------------

$wm-breakpoints: (
    all: 0px,
    sm: 576px,
    md: 768px,
    lg: 992px,
    xl: 1200px
) !default;
$wm-breakpoint-placeholder: SCR !default;
$wm-value-placeholder: VAL !default;
$wm-min-breakpoint-prefix: false !default;
$wm-min-breakpoint-addition: 1 !default;

// ------------------------------
// Main mixin
// ------------------------------

$wm-mixin-name: 'windmill';
$wm-warning-title: '[Windmill warn]: ';

@mixin windmill(
    $content: null,
    $vars: null,
    $remove: null,
    $selector: null,
    $breakpoints: $wm-breakpoints,
    $disable: false
) {
    $content: wm-make-declarations-with-shorthand($content);
    $vars: wm-make-values-with-shorthand($vars);

    // Convert the value to string in $content of (property: value).
    @if $content != null {
        $content: wm-declarations-to-string($content);
    }

    @if $selector {
        $selector: wm-list-to-text($selector, $separator: ', ');
    } @else {
        $selector: wm-list-to-text(&, $separator: ', ');
    }

    @if $breakpoints == true {
        $breakpoints: $wm-breakpoints;
    }
    // If $selector contains no $wm-breakpoint-placeholder,
    // sets false to $breakpoints.
    @if $selector and length(wm-split-selector-without-substr($selector, $wm-breakpoint-placeholder)) == wm-get-selector-group-number($selector) {
        $breakpoints: false;
    }

    $no-exception: wm-handle-exception($selector, $breakpoints, $content, $vars, $disable);
    @if $no-exception {
        // Removes specific the value-name from $vars.
        @if $vars and $remove {
            $vars: wm-remove-value-names($vars, $remove...);
        }

        // Warns mismatch that the number of variables in $content and $vars.
        @if $content and $vars {
            @include wm-warn-var-number-mismatch($content, $vars);
        }

        @if not $breakpoints {
            @include wm-output-declarations-without-var($selector, false, false, $content, $vars) {
                @content;
            }
            @if $content and $vars {
                @each $value-name in wm-get-value-names($vars) {
                    @include wm-output-declarations-with-var($selector, false, false, $content, $vars, $value-name);
                }
            }
        }

        @if $breakpoints {
            @each $breakpoint-name, $breakpoint in $breakpoints {
                @include wm-mq($breakpoint) {
                    @include wm-output-declarations-without-var($selector, $breakpoints, $breakpoint-name, $content, $vars) {
                        @content;
                    }
                    @if $content and $vars {
                        @each $value-name in wm-get-value-names($vars) {
                            @include wm-output-declarations-with-var($selector, $breakpoints, $breakpoint-name, $content, $vars, $value-name);
                        }
                    }
                }
            }
        }
    }
}
